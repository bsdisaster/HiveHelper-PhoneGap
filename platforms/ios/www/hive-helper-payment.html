<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <title>Helper payment - Hive Helper 1.0</title>
    <link rel="icon" href="images/icon.ico">
    <link rel="stylesheet" type="text/css" href="styles/style.css">
    <link rel="stylesheet" type="text/css" href="styles/skin.css">
    <link rel="stylesheet" type="text/css" href="styles/framework.css">
    <link rel="stylesheet" type="text/css" href="styles/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="styles/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="styles/ionicons.min.css">

    <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script type="text/javascript" src="scripts/jquery.js"></script>
    <script type="text/javascript" src="scripts/jquery-ui.min.js"></script>
    <script type="text/javascript" src="scripts/plugins.js"></script>
    <script type="text/javascript" src="scripts/custom.js"></script>
    <script type="text/javascript" src="scripts/stripe.js"></script>

    <script type="text/javascript" src="scripts/jquery.maskedinput.min.js"></script>
    <script type="text/javascript" src="cordova.js"></script>

</head>

<body>
    <div id="page-transitions">

        <div class="header header-logo-center header-light">
            <img src="images/HiveHelper_Logo.png" />
        </div>
        <div id="page-content" class="page-content set-background-splash2">
            <div id="page-content-scroll" class="header-clear">
                <!--Enables this element to be scrolled -->
                <div class="heading-strip">
                    <h3 class="center-text futura-medium">Payment For</h3>
                </div>
                <div class="page-login content futura-pt-book">
                    <div>
                        <h3>
                            <label>
                                <span>Service: </span>
                                <span id="serviceName"></span>
                            </label>
                        </h3>
                        <h3>
                            <label>
                                <span>Provider: </span>
                                <span id="provideName"></span>
                            </label>
                        </h3>
                        <h3>
                            <label>
                                <span>Date: </span>
                                <span id="dateValue"></span>
                            </label>
                        </h3>
                    </div>
                    <br />
                    <div>
                        <div>
                            <h3>Select card for payment :</h3>
                            <br />
                            <div id="dvCardSelection">
                                <div>
                                    No card on file
                                </div>
                                <br />
                            </div>
                        </div>
                        
                        <div class="userDetails">
                            <div>
                                <input type="text" id="firstName" class="input-text-box input-green-border" placeholder="First name">
                            </div>
                            <div>
                                <input type="text" id="lastName" class="input-text-box input-green-border" placeholder="Last name">
                            </div>
                        </div>
                        
                        <div id="dvNewCardSelection" style="display:none">
                            <div>
                                <input type="text" id="emailAddress" class="input-text-box input-green-border" placeholder="Email address">
                            </div>
                            <div class="col-sm-12">
                                <div class="col-sm-12">
                                    <input type="text" id="cardNumber" class="input-text-box input-green-border" placeholder="Card number">
                                </div>
                            </div>
                            <div>
                                <div class="col-sm-12">
                                    <div class="col-sm-6">
                                        <input type="text" id="expiry" class="input-text-box input-green-border" placeholder="MM/YY">
                                    </div>
                                    <div class="col-sm-6">
                                        <input type="text" id="cvc" class="input-text-box input-green-border" placeholder="CVV">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="clear">&nbsp;</div>
                        <div class="col-sm-12">
                            <a href="#" onclick="applyPromocode()">Have a promocode ?</a>
                            <div id="dvPromocode" class="col-sm-12" style="display:none">
                                <div class="col-sm-11">
                                    <input type="text" id="promoCode" class="input-text-box input-green-border" placeholder="Promo code">
                                </div>
                                <div class="col-sm-1">
                                    <a href="#" id="lnkPromoCode" onclick="checkPromocode()"><i class="fa fa-check-circle"></i></a>
                                </div>
                                <div class="col-sm-12">
                                    <div><h6><label class="color-green-dark"></label></h6></div>
                                    <div><h6><label class="color-green-dark"></label></h6></div>
                                </div>
                            </div>
                        </div>
                        <button id="btnPayment" class="button button-blue button-full half-top full-bottom"></button>
                    </div>
                    <a href="#" onclick="newCardDetails()">Add New Card</a><br />
                </div>
            </div>

            <script type="text/javascript">
                $(document).ready(function () {
                    $("#cardNumber").mask("9999-9999-9999-9999");
                    $("#expiry").mask("99/99");

                    submitPaymentInfo();
                    fetchProviderInfo();
                    if (!isMobileDevice) {
                        listCardDetails(localStorage.getItem("userId"));
                    }

                    if (localStorage.getItem("zipcode")) {
                        $("#homeLink").attr("href", "index.html");
                        $(".userDetails").show();
                        $("#dvCardSelection").parent("div").hide();
                    } else {
                        $("#homeLink").attr("href", "dashboard.html");
                        $(".userDetails").hide();
                        $("#dvCardSelection").parent("div").show();
                    }
                }).on('deviceready', function () {
                    listCardDetails(localStorage.getItem("userId"));
                });

                var isMobileDevice = isMobile();
                var existingCustomerId = null;
                var selectedCard = null;
                var selectedCustomer = null;

                function fetchProviderInfo() {
                    var service = localStorage.getItem("selectedCleaningTitle");
                    serviceTitle = service.substr(0, service.lastIndexOf(" "));
                    serviceHours = serviceTitle.slice(0, 1);

                    var paymentValue = service.substr(service.lastIndexOf(" "));
                    $("#btnPayment").text("Pay " + paymentValue.substring(service + 1));
                    $("#emailAddress").val(localStorage.getItem("username"));
                    $("#serviceName").text(serviceTitle);
                    $("#provideName").text(localStorage.getItem("franchiseName"));
                    $("#dateValue").text(localStorage.getItem("providerDate"));
                }

                function applyPromocode() {
                    $("#dvPromocode").show();
                    $("#promoCode").focus();
                }

                function getCardDetails(ele) {
                    selectedCard = $(ele).attr("data-card-id");
                    selectedCustomer = $(ele).attr("data-customer-id");

                    $(".payment-cards").removeAttr("style");
                    $(ele).parent().css("background-color", "lightblue");
                    $("#dvNewCardSelection").hide();
                }

                function newCardDetails() {
                    $("#dvNewCardSelection").show();
                    $("#cardNumber").focus();
                    $(".payment-cards").removeAttr("style");
                }

                function listCardDetails(userId) {

                    if (isMobileDevice) {
                        window.plugins.spinnerDialog.show("Please wait...", "Loading...", true);
                    } else {
                        showLoading(true);
                    }

                    $.ajax({
                        url: api_baseUrl + 'Savecard/listCard/' + userId,
                        type: "GET",
                        dataType: "JSON",
                        success: function (response) {
                            
                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                            } else {
                                showLoading(false);
                            }

                            if (response !== null && response.status === 1) {

                                var customer = response.data.customerdata[0];
                                existingCustomerId = customer.customerId;

                                if (customer.card.length > 0) {
                                    $("#dvCardSelection > div").empty();
                                    for (var j = 0; j < customer.card.length; j++) {
                                        var html = "";

                                        html = html + '<a href="#" class="payment-cards">';
                                        html = html + '<strong class="user-list-3-strong" data-card-id="' + customer.card[j].customercardId + '" data-customer-id="' + existingCustomerId + '" onclick="getCardDetails(this)">XXXX-XXXX-XXXX-' + customer.card[j].last4 + '</strong>';
                                        html = html + '<i class="fa fa-trash-o" onclick="deleteStripeCard(this)"></i></a>';

                                        $("#dvCardSelection > div").append(html);
                                    }
                                }
                            } else {
                                $("#dvNewCardSelection").show();
                            }
                        },
                        error: function (jqXHR, text, error) {
                            // Displaying if there are any errors
                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                            } else {
                                showLoading(false);
                            }

                            if (error == null || error == "") {
                                if (isMobileDevice) {
                                    navigator.notification.alert("It looks like you're offline.!", null, 'Error', 'Close');
                                }

                            } else {
                                if (isMobileDevice) {
                                    navigator.notification.alert(error, null, 'Error', 'Close');
                                } else {
                                    showAlertDialog('Error', error);
                                }
                            }
                        }
                    });
                }

                function deleteCardDb(customerId, cardId) {

                    if (isMobileDevice) {
                        window.plugins.spinnerDialog.show("Please wait...", "Loading...", true);
                    } else {
                        showLoading(true);
                    }

                    var params = {

                        "customerId": customerId,
                        "userId": localStorage.getItem("userId"),
                        "customercardId": cardId
                    }

                    $.ajax({
                        url: api_baseUrl + 'Savecard/deleteCard/',
                        type: "POST",
                        data: JSON.stringify(params),
                        dataType: "JSON",
                        success: function (response) {
                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                            } else {
                                showLoading(false);
                            }

                            if (response !== null && response.status === 1) {

                            } else {
                                if (isMobileDevice) {
                                    navigator.notification.alert(response.message, null, 'Warning', 'Close');
                                } else {
                                    showAlertDialog('Warning', response.message);
                                }
                            }
                        },

                        error: function (jqXHR, text, error) {

                            // Displaying if there are any errors
                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                            } else {
                                showLoading(false);
                            }

                            if (error == null || error == "") {
                                if (isMobileDevice) {
                                    navigator.notification.alert("It looks like you're offline.!", null, 'Error', 'Close');
                                }

                            } else {
                                if (isMobileDevice) {
                                    navigator.notification.alert(error, null, 'Error', 'Close');
                                } else {
                                    showAlertDialog('Error', error);
                                }
                            }
                        }
                    })
                }

                function deleteStripeCard(divEle) {

                    var customerId = $(divEle).siblings().attr("data-customer-id");
                    var cardId = $(divEle).siblings().attr("data-card-id");

                    if (isMobileDevice) {
                        navigator.notification.confirm("Are you sure you want to delete this card?", function (button) {
                            if (button === 1) {
                                window.plugins.spinnerDialog.show("Please wait...", "Loading...", true);

                                $.ajax({
                                    type: 'DELETE',
                                    url: 'https://api.stripe.com/v1/customers/' + customerId + '/sources/' + cardId,
                                    headers: {
                                        Authorization: 'Bearer ' + localStorage.getItem("stripeSecretKey")
                                        //Authorization: 'Bearer sk_test_PeyWFcrok8LpSQlgTBDva9Rt'
                                    },
                                    success: (data) => {

                                        window.plugins.spinnerDialog.hide();
                                        $(divEle).parent().remove();
                                        deleteCardDb(customerId, cardId);
                                        navigator.notification.alert("Card successfully deleted!", null, 'Success', 'Close');
                                    },
                                    error: (response) => {

                                        window.plugins.spinnerDialog.hide();
                                        navigator.notification.alert(response.responseJSON.error.message, null, 'Error', 'Close');
                                    }
                                })
                            }
                        }, "Warning", "Ok,Cancel");
                    } else {

                        var res = confirm("Are you sure you want to delete this card?");
                        if (res == true) {
                            showLoading(true);
                            $.ajax({
                                type: 'DELETE',
                                url: 'https://api.stripe.com/v1/customers/' + customerId + '/sources/' + cardId,
                                headers: {
                                    Authorization: 'Bearer ' + localStorage.getItem("stripeSecretKey")
                                    //Authorization: 'Bearer sk_test_PeyWFcrok8LpSQlgTBDva9Rt'
                                },
                                success: (data) => {
                                    showLoading(false);
                                    $(divEle).parent().remove();
                                    deleteCardDb(customerId, cardId);
                                    showAlertDialog("Success", "Card successfully deleted!");
                                },
                                error: (response) => {
                                    showLoading(false);
                                    showAlertDialog("Error", response.responseJSON.error.message);
                                }
                            })
                        }

                    }
                }

                function checkPromocode() {

                    if ($("#promoCode").val() == "") {
                        if (isMobileDevice) {
                            navigator.notification.alert("Please enter promo code!", null, 'Warning', 'Close');

                        } else {
                            showAlertDialog("Warning", "Please enter promo code!");
                        }
                        $("#promoCode").focus();
                    }
                    else {
                        if (isMobileDevice) {
                            window.plugins.spinnerDialog.show("Please wait...", "Validating code...", true);
                        } else {
                            showLoading(true);
                        }

                        var parameter = {
                            "franchiseId": localStorage.getItem("franchiseId"),
                            "serviceId": localStorage.getItem("serviceId"),
                            "subserviceId": localStorage.getItem("subServiceId"),
                            "promocode": $("#promoCode").val()
                        }

                        $.ajax({
                            url: api_baseUrl + 'Promocode',
                            type: "POST",
                            data: JSON.stringify(parameter),
                            dataType: "JSON",
                            success: function (response) {
                                
                                if (isMobileDevice) {
                                    window.plugins.spinnerDialog.hide();
                                } else {
                                    showLoading(false);
                                }

                                if (response !== null && response.status === 1) {
                                    if (isMobileDevice) {
                                        navigator.notification.alert("Promocode applied", null, 'Success', 'Close');

                                    } else {
                                        showAlertDialog("Success", "Promocode applied");
                                    }

                                    var regularPrice = parseFloat(localStorage.getItem("regularPrice"));
                                    $($(".color-green-dark")[0]).text("Regular amount: " + "$" + regularPrice);
                                    $($(".color-green-dark")[1]).text("Discount amount: " + "$" + response.data[0].price);

                                    $("#btnPayment").text("Pay $" + parseFloat(regularPrice - response.data[0].price));
                                    $("#promoCode").attr("disabled", "disabled").css("border-color", "green");
                                    $("#lnkPromoCode").removeAttr("onclick");
                                }
                                else {
                                    if (isMobileDevice) {
                                        navigator.notification.alert(response.message, null, 'Warning', 'Close');
                                    } else {
                                        showAlertDialog('Warning', response.message);
                                    }
                                    $("#promoCode").css("border-color", "red");
                                }
                            },
                            error: function (jqXHR, text, error) {
                                // Displaying if there are any errors
                                if (isMobileDevice) {
                                    window.plugins.spinnerDialog.hide();
                                } else {
                                    showLoading(false);
                                }

                                if (error == null || error == "") {
                                    if (isMobileDevice) {
                                        navigator.notification.alert("It looks like you're offline.!", null, 'Error', 'Close');
                                    }

                                } else {
                                    if (isMobileDevice) {
                                        navigator.notification.alert(error, null, 'Error', 'Close');
                                    } else {
                                        showAlertDialog('Error', error);
                                    }
                                }
                            }
                        });
                    }
                }

                function isValidatePaymentInfo() {
                    var isResult = true;
                    var countError = 0;
                    var msg = "Please correct following fields:\n";

                    var emailValue = $("#emailAddress").val().trim();
                    var cardNumber = $("#cardNumber").val();
                    var expiry = $("#expiry").val();
                    var cvv = $("#cvc").val().trim();
                    var firstName = $("#firstName").val().trim();
                    var lastName = $("#lastName").val().trim();

                    if ($(".userDetails").is(':visible')) {
                        if (firstName === '') {
                            countError = countError + 1;
                            msg += "First Name!\n";
                        }
                        if (lastName === '') {
                            countError = countError + 1;
                            msg += "Last Name!\n";
                        }
                    }
                    if (emailValue === '') {
                        countError = countError + 1;
                        msg += "Email address!\n";
                    }
                    if (cardNumber === '') {
                        countError = countError + 1;
                        msg += "Card Number!\n";
                    }
                    if (expiry === '') {
                        countError = countError + 1;
                        msg += "Expiry date!\n";
                    }
                    if (cvv === '') {
                        countError = countError + 1;
                        msg += "CVC!\n";
                    }
                    

                    if (emailValue !== '') {
                        var x = emailValue;
                        var atpos = x.indexOf("@");
                        var dotpos = x.lastIndexOf(".");
                        if (atpos < 1 || dotpos < atpos + 2 || dotpos + 2 >= x.length) {
                            countError = countError + 1;
                            msg += "Valid email address!\n";
                        }
                    }
                    if (expiry !== '') {
                        var isValid = validateExpiryDate(expiry);
                        if (!isValid) {
                            countError = countError + 1;
                            msg += "Valid date in MM/YY format!\n";
                        }
                    }
                    if (cvv !== '') {
                        var isValid = validateCvcNumber(cvv);
                        if (!isValid) {
                            countError = countError + 1;
                            msg += "Valid cvc number!\n";
                        }
                    }

                    if (countError > 0) {
                        if (isMobileDevice) {
                            navigator.notification.alert(msg, null, 'Warning', 'Close');
                        } else {
                            showAlertDialog('Warning', msg);
                        }
                        isResult = false;
                    }
                    return isResult;
                }

                function validateExpiryDate(dValue) {
                    var result = false;
                    dValue = dValue.split('/');
                    var pattern = /^\d{2}$/;

                    if (dValue[0] < 1 || dValue[0] <= 12)
                        result = true;

                    if (!pattern.test(dValue[0]) || !pattern.test(dValue[1]))
                        result = true;

                    if (dValue[2])
                        result = true;

                    if (result)
                        return true;
                    else
                        return false;
                }

                function validateCvcNumber(number) {
                    if (!number.match(/^[0-9]{3,4}$/))
                        return false;
                    else
                        return true;
                }

                function createCard(secretkey, customerId, source, parameters, tokenInfo) {

                    if (isMobileDevice) {
                        window.plugins.spinnerDialog.show("Please wait...", "Loading...", true);
                    } else {
                        showLoading(true);
                    }

                    var params = {
                        "secretkey": secretkey,
                        "customerId": customerId,
                        "source": source
                    }

                    $.ajax({
                        type: 'POST',
                        url: api_baseUrl + 'Savecard/createCard/',
                        data: JSON.stringify(params),
                        success: (data) => {

                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                            } else {
                                showLoading(false);
                            }

                            if (parameters != null && tokenInfo != null) {
                                createCharge(parameters, tokenInfo);
                            }
                        },
                        error: (response) => {

                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                                navigator.notification.alert(response.responseJSON.error.message, null, 'Error', 'Close');
                            } else {
                                showLoading(false);
                                showAlertDialog('Error', response.responseJSON.error.message);
                            }
                        }
                    })
                }

                function submitPaymentInfo() {
                    $('#btnPayment').on('click', function (event) {

                        if ($("#dvNewCardSelection").is(":visible")) {
                            if (isValidatePaymentInfo()) {
                                if (isMobileDevice) {
                                    window.plugins.spinnerDialog.show("Please wait...", "Loading...", true);
                                } else {
                                    showLoading(true);
                                }

                                var cardNumber = $("#cardNumber").val();
                                var expiry = $("#expiry").val();
                                var cvv = $("#cvc").val();

                                stripePayment(cardNumber, expiry, cvv);
                            }
                        } else if (selectedCard == null && selectedCustomer == null) {
                            if (isMobileDevice) {
                                navigator.notification.alert("Please select card for payment!", null, 'Warning', 'Close');
                            } else {
                                showAlertDialog('Warning', "Please select card for payment!");
                            }
                        } else {
                            makePayment();
                        }
                    });
                }

                function stripePayment(cardNumber, expiry, cvc) {
                    Stripe.setPublishableKey(localStorage.getItem("stripePublishableKey"));
                    //Stripe.setPublishableKey("pk_test_z63RIQFh5e1As9i7kecp5AsS");

                    Stripe.card.createToken({
                        name: sessionStorage.getItem("userName"),
                        number: cardNumber,
                        cvc: cvc,
                        exp_month: expiry.split("/")[0],
                        exp_year: expiry.split("/")[1]
                    }, stripeResponseHandler);
                };

                var stripeResponseHandler = function (status, response) {
                    if (response.error) {

                        if (isMobileDevice) {
                            window.plugins.spinnerDialog.hide();
                            navigator.notification.alert(response.error.message, null, 'Error', 'Close');
                        } else {
                            showLoading(false);
                            showAlertDialog('Error', response.error.message);
                        }
                    } else {
                        // Get the token ID:
                        var tokenInfo = response;
                        console.log(tokenInfo);

                        // Save token mapping it to customer for all future payment activities
                        if (existingCustomerId == null) {
                            createCustomer(tokenInfo);
                        } else {

                            makePayment(tokenInfo);
                            saveCardDetails(tokenInfo);

                        }
                    }
                }

                function createCustomer(tokenInfo) {
                    $.ajax({
                        type: 'POST',
                        url: 'https://api.stripe.com/v1/customers',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.getItem("stripeSecretKey")
                            //Authorization: 'Bearer sk_test_PeyWFcrok8LpSQlgTBDva9Rt'
                        },
                        data: {
                            "email": $("#emailAddress").val(),
                            "source": tokenInfo.id,
                        },
                        success: (data) => {

                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                            } else {
                                showLoading(false);
                            }

                            localStorage.setItem("clientIp", tokenInfo.client_ip);
                            if (localStorage.getItem("zipcode") == null) {
                                saveCardDetails(data);
                            }
                            makePayment(data);
                        },
                        error: (response) => {

                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                                navigator.notification.alert(response.responseJSON.error.message, null, 'Error', 'Close');
                            } else {
                                showLoading(false);
                                showAlertDialog('Error', response.responseJSON.error.message);
                            }
                        }
                    })
                }

                function makePayment(tokenInfo) {
                    var params = null;

                    if (tokenInfo == null && existingCustomerId != null) {

                        params = {
                            amount: (parseFloat($("#btnPayment").text().replace(/[^0-9.]/g, '').split('.')[0]) * 100),
                            source: selectedCard,
                            customer: selectedCustomer,
                            description: "Hive Helper - " + localStorage.getItem("selectedCleaningTitle") + " - " + (localStorage.getItem("providerDate").toString().replace(/-/g, "/")),
                            currency: "USD"
                        }
                        createCharge(params, tokenInfo);
                    } else if (tokenInfo != null && existingCustomerId != null) {

                        params = {
                            amount: (parseFloat($("#btnPayment").text().replace(/[^0-9.]/g, '').split('.')[0]) * 100),
                            source: tokenInfo.card.id,
                            customer: existingCustomerId,
                            description: "Hive Helper - " + localStorage.getItem("selectedCleaningTitle") + " - " + (localStorage.getItem("providerDate").toString().replace(/-/g, "/")),
                            currency: "USD"
                        }
                        createCard(localStorage.getItem("stripeSecretKey"), existingCustomerId, tokenInfo.id, params, tokenInfo);
                    }
                    else {
                        params = {
                            amount: (parseFloat($("#btnPayment").text().replace(/[^0-9.]/g, '').split('.')[0]) * 100),
                            customer: tokenInfo.id,
                            description: "Hive Helper - " + localStorage.getItem("selectedCleaningTitle") + " - " + (localStorage.getItem("providerDate").toString().replace(/-/g, "/")),
                            currency: "USD"
                        }
                        createCharge(params, tokenInfo);
                    }

                }

                function createCharge(parameters, tokenInfo) {
                    if (isMobileDevice) {
                        window.plugins.spinnerDialog.show("Please wait...", "Loading...", true);
                    } else {
                        showLoading(true);
                    }

                    $.ajax({
                        type: 'POST',
                        url: 'https://api.stripe.com/v1/charges',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.getItem("stripeSecretKey")
                            //Authorization: 'Bearer sk_test_PeyWFcrok8LpSQlgTBDva9Rt'
                        },
                        data: parameters,
                        success: (data) => {
                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                            } else {
                                showLoading(false);
                            }

                            if (tokenInfo == null) {
                                localStorage.setItem("clientIp", "");
                            } else {
                                localStorage.setItem("clientIp", tokenInfo.client_ip);
                            }

                            savePaymentInfo(data);

                        },
                        error: (response) => {
                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                                navigator.notification.alert(response.responseJSON.error.message, null, 'Error', 'Close');
                            } else {
                                showLoading(false);
                                showAlertDialog('Error', response.responseJSON.error.message);
                            }
                        }
                    })
                }

                function convertTimeformat(format, time) {
                    var hours = Number(time.match(/^(\d+)/)[1]);
                    var minutes = Number(time.match(/:(\d+)/)[1]);
                    var AMPM = time.match(/\s(.*)$/)[1];
                    if ((AMPM == "pm" || AMPM == "PM") && hours < 12) hours = hours + 12;
                    if ((AMPM == "am" || AMPM == "AM") && hours == 12) hours = hours - 12;
                    var sHours = hours.toString();
                    var sMinutes = minutes.toString();
                    if (hours < 10) sHours = "0" + sHours;
                    if (minutes < 10) sMinutes = "0" + sMinutes;
                    return (sHours + ":" + sMinutes).toString();
                }

                function saveCardDetails(cardDetails) {
                    if (isMobileDevice) {
                        window.plugins.spinnerDialog.show("Please wait...", "Loading...", true);
                    } else {
                        showLoading(true);
                    }

                    var parameter = null;

                    if (existingCustomerId == null) {
                        parameter = {
                            "customerId": cardDetails.id,
                            "object": cardDetails.object,
                            "email": cardDetails.email,
                            "created": cardDetails.created,
                            "customercardId": cardDetails.sources.data[0].id,
                            "userId": localStorage.getItem("userId"),
                            "customerObject": cardDetails.sources.data[0].object,
                            "brand": cardDetails.sources.data[0].brand,
                            "country": cardDetails.sources.data[0].country,
                            "exp_month": cardDetails.sources.data[0].exp_month,
                            "exp_year": cardDetails.sources.data[0].exp_year,
                            "fingerprint": cardDetails.sources.data[0].fingerprint,
                            "funding": cardDetails.sources.data[0].funding,
                            "last4": cardDetails.sources.data[0].last4,
                            "customername": cardDetails.sources.data[0].name,
                        };
                    } else {
                        parameter = {
                            "customerId": existingCustomerId,
                            "object": cardDetails.object,
                            "email": $("#emailAddress").val(),
                            "created": cardDetails.created,
                            "customercardId": cardDetails.card.id,
                            "userId": localStorage.getItem("userId"),
                            "customerObject": cardDetails.card.object,
                            "brand": cardDetails.card.brand,
                            "country": cardDetails.card.country,
                            "exp_month": cardDetails.card.exp_month,
                            "exp_year": cardDetails.card.exp_year,
                            "fingerprint": "",
                            "funding": cardDetails.card.funding,
                            "last4": cardDetails.card.last4,
                            "customername": cardDetails.card.name,
                        };
                    }

                    $.ajax({
                        url: api_baseUrl + 'Savecard/',
                        type: "POST",
                        data: JSON.stringify(parameter),
                        success: function (response) {
                            
                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                            } else {
                                showLoading(false);
                            }

                            if (response !== null && response.status === 1) {

                            }
                            else {
                                if (isMobileDevice) {
                                    navigator.notification.alert(response.message, null, 'Warning', 'Close');
                                } else {
                                    showAlertDialog('Warning', response.message);
                                }
                            }
                        },
                        error: function (jqXHR, text, error) {

                            // Displaying if there are any errors
                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                            } else {
                                showLoading(false);
                            }

                            if (error == null || error == "") {
                                if (isMobileDevice) {
                                    navigator.notification.alert("It looks like you're offline.!", null, 'Error', 'Close');
                                }

                            } else {
                                if (isMobileDevice) {
                                    navigator.notification.alert(error, null, 'Error', 'Close');
                                } else {
                                    showAlertDialog('Error', error);
                                }
                            }
                        }
                    });
                }

                function savePaymentInfo(tokenInfo) {
                    if (isMobileDevice) {
                        window.plugins.spinnerDialog.show("Please wait...", "Loading...", true);
                    } else {
                        showLoading(true);
                    }

                    var helperSelectedTime = localStorage.getItem("helperSelectedTime");

                    var unAuthorizedUser = {};
                    

                    if (localStorage.getItem("zipcode") != null) {
                        unAuthorizedUser.email = $("#emailAddress").val();
                        unAuthorizedUser.address = localStorage.getItem("address");
                        unAuthorizedUser.firstname = $("#firstName").val();
                        unAuthorizedUser.lastname = $("#lastName").val();
                        unAuthorizedUser.zipcode = localStorage.getItem("zipcode");

                        var index = api_baseUrl.indexOf("appv2");

                        if (index == "-1") {
                            unAuthorizedUser.registerurl = "http://hivehelperapp.com/client-registration.html";
                        } else {
                            unAuthorizedUser.registerurl = "http://1.22.229.11/HiveHelperMobile/client-registration.html";
                        }
                    }

                    var parameter = {
                        "serviceId": localStorage.getItem("serviceId"),
                        "userId": localStorage.getItem("userId"),
                        "subServiceId": localStorage.getItem("subServiceId"),
                        "userAddressId": localStorage.getItem("userAddressId"),
                        "appointmentDate": localStorage.getItem("providerDate"),
                        "appointmentFrom": convertTimeformat("24", helperSelectedTime.split('-')[0]),
                        "appointmentTo": convertTimeformat("24", helperSelectedTime.split('-')[1]),
                        "franchiseId": localStorage.getItem("franchiseId"),
                        "transactionId": tokenInfo.id,
                        "transactionObject": tokenInfo.source.object,
                        "transactionUserName": tokenInfo.source.name,
                        "cardUserAddress": tokenInfo.source.address_line1 + "," + tokenInfo.source.address_line2,
                        "cardUserState": tokenInfo.source.address_state ? tokenInfo.source.address_state : "",
                        "cardUserCountry": tokenInfo.source.country,
                        "cardUserZipcode": tokenInfo.source.address_zip ? tokenInfo.source.address_zip : "",
                        "cardBrand": tokenInfo.source.brand,
                        "currency": "USD",
                        "appointmentPrice": $("#btnPayment").text().replace(/[^0-9.]/g, '').split('.')[0],
                        "cardTranactionId": tokenInfo.source.id,
                        "cardLastDigit": tokenInfo.source.last4,
                        "cardFunding": tokenInfo.source.funding,
                        "cardExpMonth": tokenInfo.source.exp_month,
                        "cardExpYear": tokenInfo.source.exp_year,
                        "paymentIp": localStorage.getItem("clientIp"),
                        "unauthorized": unAuthorizedUser,
                        "QuestionAnswer": JSON.parse(localStorage.getItem("paymentTempObject"))
                    };

                    $.ajax({
                        url: api_baseUrl + 'appointment/',
                        type: "POST",
                        data: JSON.stringify(parameter),
                        success: function (response) {
                            
                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                            } else {
                                showLoading(false);
                            }

                            if (response !== null && response.status === 1) {

                                if (isMobileDevice) {
                                    navigator.notification.alert("Your appointment successfully booked!", null, 'Success', 'Close');
                                } else {
                                    showAlertDialog("Success", "Your appointment successfully booked!");
                                }

                                localStorage.removeItem("paymentTempObject");
                                sessionStorage.clear();

                                setTimeout(function () {
                                    if (localStorage.getItem("zipcode")) {
                                        window.location.href = "index.html";
                                    } else {
                                        window.location.href = "dashboard.html";
                                    }
                                }, 1000);
                            }
                            else {
                                if (isMobileDevice) {
                                    navigator.notification.alert(response.message, null, 'Warning', 'Close');
                                } else {
                                    showAlertDialog('Warning', response.message);
                                }
                            }
                        },
                        error: function (jqXHR, text, error) {

                            // Displaying if there are any errors
                            if (isMobileDevice) {
                                window.plugins.spinnerDialog.hide();
                            } else {
                                showLoading(false);
                            }

                            if (error == null || error == "") {
                                if (isMobileDevice) {
                                    navigator.notification.alert("It looks like you're offline.!", null, 'Error', 'Close');
                                }

                            } else {
                                if (isMobileDevice) {
                                    navigator.notification.alert(error, null, 'Error', 'Close');
                                } else {
                                    showAlertDialog('Error', error);
                                }
                            }
                        }
                    });
                }

            </script>
            <div class="clear"></div>
        </div>
        <footer class="sticky-footer">
            <div class="n_footer-links">
                <div class="footer-link-r">
                    <a href="bookhelper-question-answer-detail.html" id="backLink" target="_self">
                        <img src="images/back_arrow.png" height="40" width="40" />
                    </a>
                </div>
                <center>
                    <h2>We Arrive. You Thrive.</h2>
                </center>
                <div class="footer-link-l">
                    <a href="dashboard.html" id="homeLink" target="_self">
                        <img src="images/Home.png" height="40" width="40" />
                    </a>
                </div>
            </div>
        </footer>
    </div>
</body>
</html>