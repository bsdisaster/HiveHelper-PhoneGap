<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <title>Payment tracking - Hive Helper 1.0</title>

    <link rel="stylesheet" type="text/css" href="styles/style.css">
    <link rel="stylesheet" type="text/css" href="styles/skin.css">
    <link rel="stylesheet" type="text/css" href="styles/framework.css">
    <link rel="stylesheet" type="text/css" href="styles/ionicons.min.css">
    <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script type="text/javascript" src="scripts/jquery.js"></script>
    <script type="text/javascript" src="scripts/jquery-ui.min.js"></script>
    <script type="text/javascript" src="scripts/plugins.js"></script>
    <script type="text/javascript" src="scripts/custom.js"></script>
    <script type="text/javascript" src="scripts/setup_baseurl.js"></script>
    <script type="text/javascript" src="cordova.js"></script>

</head>

<body>
    <div id="page-transitions">

        <div class="header header-logo-center header-light">
            <a href="dashboard.html" class="header-icon header-icon-5" target="_self">
                <img src="images/back_arrow.png" height="20" />
            </a>
            <a href="dashboard.html" target="_self" class="header-logo"></a>
        </div>

        <div id="page-content" class="page-content futura-pt-book">
            <div id="page-content-scroll" class="header-clear">
                <div class="clear">&nbsp;</div>

                <h3 class="center-text futura-medium">Hours/Pay</h3>
                <div class="pageapp-login">
                    <div>
                        <input type="checkbox" id="chkPaidJobs" onchange="toggleButtonChangeText(this)">
                        <label for="chkPaidJobs" id="lblPaidJobs">Unpaid jobs</label>
                    </div>
                    <div class="clear">&nbsp;</div>
                    <div id="rangeBox" style="display:none">
                        <div class="page-login-input light calendar-bgcolor calender-pay-h">
                            <i class="login-icon ion-calendar calendar-line-height"></i>
                            <input id="calDate1" type="text" value="From Date" onchange="getPaymentHistory()">
                        </div>
                        <div class="page-login-input light calendar-bgcolor calender-pay-h">
                            <i class="login-icon ion-calendar calendar-line-height"></i>
                            <input id="calDate2" type="text" value="To Date" onchange="getPaymentHistory()">
                        </div>
                        <div class="clear">&nbsp;</div>
                    </div>
                </div>
                <div class="payment-total">
                    <div class="page-login-input animate-fade">
                        <h3>
                            <label class="bold inline-block">Total : </label>
                            <pre class="inline-block" id="lblGrandTotal"></pre>
                        </h3>
                    </div>
                </div>
                <div class="clear">&nbsp;</div>
                <div>
                    <table id="tblPayment" class="smaller-font">
                        <tr class="bold">
                            <td>Date</td>
                            <td>Service</td>
                            <td>Customer</td>
                            <td>Hours</td>
                            <td>Rate</td>
                            <td>Total</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<script>
    $(document).ready(function () {

        var date = new Date();
        selectedWeekDayNumber = date.getUTCDay() + 1;

        rangeBoxes();
        removeFocus('#calDate1');
        removeFocus('#calDate2');

        if (!isMobileDevice) {
            getPaymentHistory();
        }

    }).on('deviceready', function () {
        document.addEventListener("deviceready", getPaymentHistory, false);
    });

    var isMobileDevice = isMobile();

    function getClickedRow() {
        $('#tblPayment tr').on('click', function () {
            $(this).find('td').each(function () {
                console.log($(this));
            });
        })
    }

    var jobType = 'unpaid';

    function toggleButtonChangeText(ele) {
        if ($(ele).is(":checked")) {
            $('#lblPaidJobs').text('Paid jobs');
            $('#rangeBox').show();
            jobType = 'paid';
        } else {
            $('#lblPaidJobs').text('Unpaid jobs');
            $('#rangeBox').hide();
            jobType = 'unpaid';
        }

        getPaymentHistory();
    }

    function rangeBoxes() {
        $('#calDate1,#calDate2').datepicker({
            dateFormat: 'dd-mm-yy'
        }).on("change", function () {
            var date = $(this).datepicker('getDate');
            selectedWeekDayNumber = date.getUTCDay() + 1;
        });
    }
    function removeFocus(inputEle) {
        $(inputEle).on('focus', function () {
            $(inputEle).blur();
        })
    }

    function getPaymentHistory() {
        if (isMobileDevice) {
            window.plugins.spinnerDialog.show("Please wait...", "Loading...", true);
        }
        var fromDate = "";
        var toDate = "";

        if ($("#calDate1").val() !== "From Date") {
            fromDate = $("#calDate1").val();
        }
        if ($("#calDate2").val() !== "To Date") {
            toDate = $("#calDate2").val();
        }

        var parameter = {
            "helperid": localStorage.getItem("userId"),
            "From": fromDate,
            "To": toDate,
            "type": jobType
        }

        $.ajax({
            url: api_baseUrl + 'Helper/helperPay/',
            data: JSON.stringify(parameter),
            type: "POST",
            dataType: "JSON",
            success: function (response) {
                // Inserting html into the result div on success
                if (isMobileDevice) {
                    window.plugins.spinnerDialog.hide();
                }

                $('#tblPayment').find("tr:gt(0)").remove();
                $('#lblGrandTotal').text("$0.0");
                if (response !== null && response.status === 1) {

                    var paymentData = response.data.helperappointment;

                    if (paymentData.length > 0) {
                        for (var i = 0; i < paymentData.length; i++) {
                            var row = '<tr onclick="viewAppointmentDetails(' + paymentData[i].appointmentId + ')"><td>' + paymentData[i].appointmentDate + '</td><td>' + paymentData[i].serviceName + '</td><td>' + paymentData[i].clientName + '</td><td>' + paymentData[i].appointmentHours + '</td><td>' + paymentData[i].perHourAmount + '</td><td>' + paymentData[i].totalAmount + '</td></tr>';
                            $('#tblPayment').append(row);
                        }
                    }
                    $('#lblGrandTotal').text(response.data.grandTotal);
                }
                else {
                    if (isMobileDevice) {
                        navigator.notification.alert(response.message, null, 'Warning', 'Close');
                    }
                    else {
                        alert(response.message);
                    }
                }
            },
            error: function (jqXHR, text, error) {
                // Displaying if there are any errors
                if (isMobileDevice) {
                    window.plugins.spinnerDialog.hide();
                }

                if (error == null || error == "") {
                    if (isMobileDevice) {
                        navigator.notification.alert("It looks like you're offline.!", null, 'Error', 'Close');
                    }

                } else {
                    if (isMobileDevice) {
                        navigator.notification.alert(error, null, 'Error', 'Close');
                    }
                    else {
                        alert(error);
                    }
                }
            }
        });

    }

    function viewAppointmentDetails(appointmentId) {
        localStorage.setItem("appointmentId", appointmentId);
        window.location = "appointment-details.html?paymenthistory=true";
    }
</script>